<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="browser-ie7 lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="browser-ie8 lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="browser-ie9 lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="browser-modern"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Brainloller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="build/tachyons.min.css">
    <link rel="stylesheet" href="assets/styles/editor.css">

    <meta name="theme-color" content="#ffffff">
    <meta name="og:site_name" content="Marcos Minond">
    <meta name="og:title" content="Marcos Minond">
    <meta name="og:description" content="My name is Marcos Minond and I am a freelance programmer.">
    <meta name="description" content="My name is Marcos Minond and I am a freelance programmer.">
    <meta name="referrer" content="origin">
  </head>
  <body>
    <section id="view"></section>
    <script src="build/main.js"></script>
    <script>
      var app = Elm.Main.embed(document.getElementById('view'));

      app.ports.uploadFile.subscribe(function (selector) {
        var URL_TMLSTORE = 'https://tmpstore.herokuapp.com/upload';
        var URL_IMGGET = 'https://tmpstore.herokuapp.com/get/';
        var URL_IMGPROCESS = 'https://8rwnim1cq1.execute-api.us-west-2.amazonaws.com/prod/pixels_pixels'
        var URL_JSONP = 'https://paddedjson.herokuapp.com/' +
          '?method=POST' +
          '&callback=CALLBACK' +
          '&url=URL' +
          '&body=BODY';

        var xhr = new XMLHttpRequest();
        var data = new FormData();

        var script = document.createElement('script');
        var input = document.querySelector(selector);
        var callback = 'callback_' + Date.now() + '_' + Math.random().toString().substr(-10);
        var file;
        var resp;

        if (input && input.files && input.files.length) {
          file = input.files[0];
        }

        if (!file) {
          console.info('uploadFile: no file found');
          return;
        }

        xhr.open('POST', URL_TMLSTORE, true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4 && xhr.status == 200) {
            try {
              resp = JSON.parse(xhr.responseText);
            } catch (err) {
              console.error('uploadFile: error parsing request (%s)', err.message);
              return;
            }

            window[callback] = function (args) {
              if (!args || !args.body || !args.body.pixels) {
                console.error('uploadFile: error processing image (%s)', args && args.errorMessage
                  ? args.errorMessage
                  : 'Unknown error');
                return;
              }

              var program = [];
              var pixels = args.body.pixels;

              for (var row = 0, rlen = pixels.length; row < rlen; row++) {
                for (var col = 0, clen = pixels[row].length; col < clen; col++) {
                  if (!program[row]) {
                    program[row] = [];
                  }

                  program[row][col] = {
                    r: pixels[row][col].R,
                    g: pixels[row][col].G,
                    b: pixels[row][col].B,
                  };
                }
              }

              app.ports.imageProcessed.send(program);
              delete window[callback];
            };

            script.src = URL_JSONP
              .replace('URL', URL_IMGPROCESS)
              .replace('CALLBACK', callback)
              .replace('BODY', encodeURI(JSON.stringify({
                path: URL_IMGGET + resp.name
              })));

            document.getElementsByTagName('head')[0].appendChild(script);
          }
        };

        data.append('file', file);
        xhr.send(data);
      });
    </script>
  </body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-102424562-1', 'auto');
  ga('send', 'pageview');
</script>
</html>
