<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="browser-ie7 lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="browser-ie8 lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="browser-ie9 lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="browser-modern"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Brainloller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="vendor/tachyons/tachyons.min.css">
    <link rel="stylesheet" href="assets/styles/editor.css">

    <meta name="theme-color" content="#ffffff">
    <meta name="og:site_name" content="Marcos Minond">
    <meta name="og:title" content="Marcos Minond">
    <meta name="og:description" content="My name is Marcos Minond and I am a freelance programmer.">
    <meta name="description" content="My name is Marcos Minond and I am a freelance programmer.">
    <meta name="referrer" content="origin">

    <link rel="prefetch" href="https://tmpstore.herokuapp.com/ping">
    <link rel="prefetch" href="https://paddedjson.herokuapp.com/ping">
  </head>
  <body>
    <section id="view"></section>
    <script src="build/main.js"></script>
    <script>
      var app = Elm.Main.embed(document.getElementById('view'));

      (function () {
        var timer;
        var delay = 40;

        function stopTimer () {
          if (timer) {
            clearTimeout(timer);
          }
        }

        app.ports.setInterpreterSpeed.subscribe(function (input) {
          var parsed = parseInt(input);
          var speed = Math.max(parsed * 10, 10);

          if (!isNaN(parsed)) {
            delay = speed;
          }
        });

        app.ports.pauseExecution.subscribe(function () {
          stopTimer();
        });

        app.ports.startExecution.subscribe(function (env) {
          stopTimer()

          function tick () {
            var runtime = env.runtime;
            var program = env.program;

            var coorX = runtime.activeCoor[0];
            var coorY = runtime.activeCoor[1];
            var cell;
            var optc;

            function memoryBackfill () {
              if (runtime.activeCell > -1) {
                for (var i = 0; i <= runtime.activeCell; i++) {
                  if (!runtime.memory[i]) {
                    runtime.memory[i] = 0;
                  }
                }
              }
            }

            if (!program[coorY] || !program[coorY][coorX]) {
              stopTimer();
              app.ports.interpreterHalt.send(runtime);
              return;
            }

            cell = program[coorY][coorX];
            optc = JSON.stringify([cell.r, cell.g, cell.b]);

            switch (optc) {
              // +90
              case '[0,255,255]':
                runtime.pointerDeg += 90;
                break;

              // -90
              case '[0,128,128]':
                runtime.pointerDeg -= 90;
                break;

              // >
              case '[255,0,0]':
                runtime.activeCell++;
                break;

              // <
              case '[128,0,0]':
                runtime.activeCell--;
                break;

              // +
              case '[0,255,0]':
                if (runtime.activeCell > -1) {
                  memoryBackfill();
                  runtime.memory[runtime.activeCell]++;
                }
                break;

              // -
              case '[0,128,0]':
                if (runtime.activeCell > -1) {
                  memoryBackfill();
                  runtime.memory[runtime.activeCell]--;
                }
                break;

              // ,
              case '[0,0,128]':
                if (runtime.activeCell > -1) {
                  memoryBackfill();

                  var input = prompt('Input');
                  var code = input ? input.charCodeAt(0) : 0;

                  runtime.memory[runtime.activeCell] = code;
                }
                break;

              // .
              case '[0,0,255]':
                if (!runtime.output) {
                  runtime.output = '';
                }

                runtime.output += String.fromCharCode(runtime.memory[runtime.activeCell]);
                console.log(runtime.output);
                break;

              // [
              case '[255,255,0]':
                if (runtime.memory[runtime.activeCell]) {
                  var jump = [
                    runtime.activeCoor[0],
                    runtime.activeCoor[1],
                    runtime.pointerDeg
                  ]

                  runtime.jumps.push(jump)
                }

                break;

              // ]
              case '[128,128,0]':
                if (runtime.memory[runtime.activeCell]) {
                  var jump = runtime.jumps.pop();

                  if (jump) {
                    coorX = jump[0];
                    coorY = jump[1];
                    runtime.pointerDeg = jump[2];

                    runtime.jumps.push(jump);
                  }
                }
                break;
            }

            if (runtime.memory[runtime.activeCell] < 0) {
              runtime.memory[runtime.activeCell] = 255;
            } else if (runtime.memory[runtime.activeCell] > 255) {
              runtime.memory[runtime.activeCell] = 0;
            }

            if (runtime.pointerDeg >= 360 || runtime.pointerDeg < 0) {
              runtime.pointerDeg = 0;
            }

            switch (runtime.pointerDeg) {
              case 0:
                runtime.activeCoor = [
                  coorX + 1,
                  coorY
                ];
                break;

              case 90:
                runtime.activeCoor = [
                  coorX,
                  coorY + 1
                ];
                break;

              case 180:
                runtime.activeCoor = [
                  coorX - 1,
                  coorY
                ];
                break;

              case 270:
                runtime.activeCoor = [
                  coorX,
                  coorY - 1
                ];
                break;
            }

            app.ports.interpreterTick.send(runtime);
            timer = setTimeout(tick, delay);
          }

          tick();
        });
      })();

      app.ports.downloadProgram.subscribe(function (program) {
        if (!program || !program.length || !program[0] || !program[0].length) {
          console.error('A program with at least one row and one column is needed');
          return
        }

        var height = program.length;
        var width = program[0].length;

        var link = document.createElement('a');
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');

        var rgb = function (pixel) {
          return ['rgb(', pixel.r, ',', pixel.g, ',', pixel.b, ')'].join('');
        };

        canvas.height = height;
        canvas.width = width;

        for (var row = 0, rlen = program.length; row < rlen; row++) {
          for (var col = 0, clen = program[row].length; col < clen; col++) {
            ctx.fillStyle = rgb(program[row][col]);
            ctx.fillRect(col, row, 1, 1);
          }
        }

        document.body.appendChild(link)
        link.style.position = 'absolute';
        link.style.top = '-1000000px';
        link.style.left = '-1000000px';

        link.href = canvas.toDataURL();
        link.download = 'brainloller-program.png';
        link.click();
      });

      app.ports.uploadProgram.subscribe(function (selector) {
        var URL_TMLSTORE = 'https://tmpstore.herokuapp.com/upload';
        var URL_IMGGET = 'https://tmpstore.herokuapp.com/get/';
        var URL_IMGPROCESS = 'https://8rwnim1cq1.execute-api.us-west-2.amazonaws.com/prod/pixels_pixels'
        var URL_JSONP = 'https://paddedjson.herokuapp.com/' +
          '?method=POST' +
          '&callback=CALLBACK' +
          '&url=URL' +
          '&body=BODY';

        var xhr = new XMLHttpRequest();
        var data = new FormData();

        var script = document.createElement('script');
        var input = document.querySelector(selector);
        var message = document.querySelector('.program-message-status');
        var callback = 'callback_' + Date.now() + '_' + Math.random().toString().substr(-10);
        var file;
        var resp;

        var setMsg = function (txt) {
          message.innerText = txt;
        };

        var clearMsg = function (txtToCheck) {
          setTimeout(function () {
            if (message.innerText === txtToCheck) {
              message.innerText = '';
            }
          }, 5000);
        };

        if (input && input.files && input.files.length) {
          file = input.files[0];
        }

        if (!file) {
          console.info('uploadFile: no file found');
          return;
        }

        setMsg('Uploading image file...');

        xhr.open('POST', URL_TMLSTORE, true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status !== 200) {
            setMsg('There was an error uploading the image file. Please try again.');
            clearMsg(message.innerText);
          } else if (xhr.readyState === 4 && xhr.status === 200) {
            try {
              resp = JSON.parse(xhr.responseText);
            } catch (err) {
              setMsg('There was an error processing the image file. Please try again.');
              clearMsg(message.innerText);
              console.error('uploadFile: error parsing request (%s)', err.message);
              return;
            }

            window[callback] = function (args) {
              if (!args || !args.body || !args.body.pixels) {
                console.error('uploadFile: error processing image (%s)', args && args.errorMessage
                  ? args.errorMessage
                  : 'Unknown error');

                setMsg('There was an error processing the image file. Please try a different file.');
                clearMsg(message.innerText);
                return;
              }

              var program = [];
              var pixels = args.body.pixels;

              for (var row = 0, rlen = pixels.length; row < rlen; row++) {
                for (var col = 0, clen = pixels[row].length; col < clen; col++) {
                  if (!program[row]) {
                    program[row] = [];
                  }

                  program[row][col] = {
                    r: pixels[row][col].R,
                    g: pixels[row][col].G,
                    b: pixels[row][col].B,
                  };
                }
              }

              app.ports.imageProcessed.send(program);
              setMsg('Ready');
              clearMsg(message.innerText);
              delete window[callback];
            };

            script.src = URL_JSONP
              .replace('URL', URL_IMGPROCESS)
              .replace('CALLBACK', callback)
              .replace('BODY', encodeURI(JSON.stringify({
                path: URL_IMGGET + resp.name
              })));

            document.getElementsByTagName('head')[0].appendChild(script);
            setMsg('Processing image...');
          }
        };

        data.append('file', file);
        xhr.send(data);
        input.value = '';
      });
    </script>

    <footer class="bt pa3 pa4-ns mt1 mt4-ns b--light-gray spectral pv3 pv4-ns">
      <div class="container">
        <p class="lh-copy w-50-ns">
        My name is
        <a href="/" class="link red dim">Marcos Minond</a>,
        and I'm a computer programmer living in Provo, Utah. Checkout my
        <a href="/resume" class="link red dim">resume</a>
        and
        <a target="_blank" href="https://github.com/minond" class="link red dim">GitHub</a>,
        and if you'd like to contact me just
        <a target="_self" href="mailto:minond.marcos+site@gmail.com" class="link red dim">send me an email</a>.
        </p>
      </div>
    </footer>
  </body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-102424562-1', 'auto');
  ga('send', 'pageview');
</script>
</html>
